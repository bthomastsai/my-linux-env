#!/bin/bash

export rootfs_path="$1"
export chroot_user="$(whoami)"
export bind_mount_pt="/dev /dev/pts $2"
bashrc_file="$rootfs_path/home/$chroot_user/.bashrc"

sudo modprobe loop

# mount workspace
#if ! mount | grep -q "$rootfs_path/home/$chroot_user/workspace"; then
#	if [ ! -d $HOME/workspace ]; then
#		mkdir -p $HOME/workspace
#	fi
#	sudo mkdir -p "$rootfs_path/home/$chroot_user/workspace"
#	sudo mount -o bind $HOME/workspace "$rootfs_path/home/$chroot_user/workspace"
#fi

# mount proc filesystem
if ! mount | grep -q "$rootfs_path/proc"; then
	sudo mount -t proc proc $rootfs_path/proc
fi


# bind-mount needed directories
for pt in $bind_mount_pt; do
	if ! mount | grep -q "${rootfs_path}$pt"; then
		sudo mkdir -p ${rootfs_path}$pt
		sudo mount -o bind $pt ${rootfs_path}$pt
	fi
done

# copy nameserver info to chroot env.
sudo cp -a /etc/resolv.conf $rootfs_path/etc

#if [ ! -f $bashrc_file ]; then
#	touch $bashrc_file 
#fi
#
## force to source /etc/profile
## /etc/profile will source /etc/profile.d/<distribution>-chroot.sh
#if ! cat $bashrc_file | grep -q '\. /etc/profile'; then
#	echo ". /etc/profile" >> $bashrc_file
#fi

